<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Bulletins Scolaires Avanc√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Setup */
        :root {
            --primary-color: #2563EB; /* Blue */
            --secondary-color: #10B981; /* Green */
            --warning-color: #F59E0B; /* Amber */
            --danger-color: #EF4444; /* Red */
            --bg-color: #f3f4f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #1f2937;
        }
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Side Panel (Summary/Averages) */
        .side-panel {
            width: 100%;
            max-width: 380px; /* Increased max width */
            background-color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            margin: 1rem;
            height: fit-content;
        }
        @media (max-width: 1024px) {
            .main-container { flex-direction: column; }
            .side-panel { max-width: 100%; }
        }

        /* Content Area (Tabs/Tables) */
        .content-area {
            flex-grow: 1;
            padding: 1rem;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.375rem 0.375rem 0 0;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #e5e7eb;
            margin-right: 0.25rem;
        }
        .tab-btn.active {
            background-color: white;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0 0.75rem 0.75rem 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .tab-content:not(.active) { display: none; }

        /* Subject Tables */
        .subject-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1.5rem; /* Space before analysis */
        }
        .subject-table thead th {
            padding: 0.75rem;
            text-align: left;
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
        }
        .subject-table thead tr:first-child th {
            font-size: 1.125rem;
            text-align: center;
        }
        .subject-table tbody tr:nth-child(even) { background-color: #f9fafb; }
        .subject-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .competency-row td {
            background-color: #d1d5db;
            font-weight: 600;
            text-align: center !important;
            padding: 0.3rem;
        }
        .no-data {
            color: #9ca3af;
            font-style: italic;
        }
        .grade-percentage {
            font-weight: 700;
            color: var(--secondary-color);
        }

        /* Inputs */
        .pond-input-field, .grade-input-field {
            width: 45px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 2px;
        }
        .pond-input-field.modified-input {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .grade-input-field {
            width: 60px;
        }
        .grade-container {
            position: relative;
            display: inline-block;
        }
        .grade-display {
            cursor: pointer;
            transition: color 0.1s;
        }
        .grade-display:hover {
            color: var(--primary-color);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
        }
        .unite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .unite-item:last-child { border-bottom: none; }
        .unite-item input { width: 60px; text-align: right; }
        
        /* Utility */
        .invalid { color: var(--danger-color); font-weight: 700; }

        .score-card {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
            border-left: 4px solid;
        }

        .score-low { border-left-color: var(--danger-color); }
        .score-medium { border-left-color: var(--warning-color); }
        .score-high { border-left-color: var(--secondary-color); }

        .score-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .prediction-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }

        .subject-analysis {
            background-color: #eff6ff; /* Blue-50 */
            border: 1px solid #bfdbfe; /* Blue-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: -1rem; /* Overlap with table bottom margin */
            margin-bottom: 1.5rem;
        }
        .analysis-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .badge-green { background-color: #D1FAE5; color: #065F46; } /* Success */
        .badge-yellow { background-color: #FEF3C7; color: #92400E; } /* Warning */
        .badge-red { background-color: #FEE2E2; color: #991B1B; } /* Danger */

    </style>
</head>
<body>

    <div class="main-container">

        <!-- Sidebar - R√©sum√© des notes -->
        <div class="side-panel lg:sticky lg:top-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Analyse de Performance</h2>

            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <p class="text-sm font-medium text-gray-500">Moyenne G√©n√©rale (Pond√©r√©e)</p>
                <strong id="moyenne-generale" class="text-4xl font-extrabold text-gray-800">--</strong>
            </div>

            <h3 class="text-lg font-semibold mb-2 text-gray-700">Param√®tres</h3>
            <div class="space-y-3 mb-6">
                <div>
                    <label for="niveau-secondaire" class="block text-sm font-medium text-gray-700">Niveau Secondaire</label>
                    <select id="niveau-secondaire" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">S√©lectionner</option>
                        <option value="sec4">Secondaire 4</option>
                        <option value="sec5">Secondaire 5</option>
                    </select>
                </div>
                <div>
                    <label for="unites-mode" class="block text-sm font-medium text-gray-700">Mode Unit√©s</label>
                    <div class="flex space-x-2">
                        <select id="unites-mode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500">
                            <option value="defaut">D√©faut (Officiel)</option>
                            <option value="sans">Sans Unit√©s (Moy. Simple)</option>
                            <option value="perso">Personnalis√©</option>
                        </select>
                        <button id="unites-btn" class="bg-gray-200 text-gray-600 rounded-md px-3 hover:bg-gray-300 transition duration-150 text-sm">√âditer</button>
                    </div>
                </div>
            </div>
            
            <h3 class="text-xl font-bold mt-6 mb-3 text-gray-800 border-t pt-3">Analyse Approfondie Globale</h3>
            <div id="deep-analysis-scorecard" class="space-y-3 mb-6">
                <div class="score-card" id="consistency-score">
                    <span class="score-icon text-gray-600">üéØ</span>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Indice de Consistance/Effort</p>
                        <strong class="text-xl text-gray-800">--</strong>
                    </div>
                </div>
                <div class="score-card" id="workload-risk">
                    <span class="score-icon text-gray-600">üî•</span>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Risque de Surcharge / Burnout</p>
                        <strong class="text-xl text-gray-800">--</strong>
                    </div>
                </div>
                <div class="score-card" id="prediction-score">
                    <span class="score-icon text-gray-600">üìà</span>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Moyenne Finale Pr√©dite (Si √âtape 3 = √âtape 2)</p>
                        <strong class="text-xl text-gray-800">--</strong>
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700 border-t pt-3">D√©tails de l'√âtape Active (<span id="active-etape-name">1</span>)</h3>
            <strong id="moyenne-etape" class="text-3xl font-extrabold text-gray-800">--</strong>

            <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700">Moyennes par Mati√®re</h3>
            <ul id="subject-averages-list" class="space-y-2 text-base">
                <!-- Subject Averages will be rendered here -->
            </ul>
        </div>

        <!-- Main Content - Tabs & Tables -->
        <div class="content-area">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">D√©tails et Simulation</h1>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-4">
                <button class="tab-btn active" data-tab="etape1">√âtape 1</button>
                <button class="tab-btn" data-tab="etape2">√âtape 2</button>
                <button class="tab-btn" data-tab="etape3">√âtape 3</button>
                <button class="tab-btn" data-tab="simulation">Simulation</button>
            </div>

            <!-- Ponderation Controls -->
            <div id="ponderation-controls" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md mb-4 flex justify-between items-center transition duration-300">
                <span>Des modifications de pond√©ration non sauvegard√©es ont √©t√© d√©tect√©es.</span>
                <div>
                    <button id="revert-ponds-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition mr-2">Annuler</button>
                    <button id="save-ponds-btn" class="bg-primary-color text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition">Sauvegarder les Ponderations</button>
                </div>
            </div>

            <!-- Tab Contents -->
            <div id="tab-contents">
                <div id="etape1" class="tab-content active">
                    <!-- Data for Etape 1 will be rendered here -->
                </div>
                <div id="etape2" class="tab-content">
                    <!-- Data for Etape 2 will be rendered here -->
                </div>
                <div id="etape3" class="tab-content">
                    <!-- Data for Etape 3 will be rendered here -->
                </div>
                <div id="simulation" class="tab-content">
                    <h2 class="text-2xl font-bold mb-4">Simulateur de Notes Finales</h2>
                    <p class="text-gray-600 mb-6">Calculez la moyenne minimale requise √† l'√âtape 3 pour atteindre votre objectif de note finale (Bas√© sur une pond√©ration 20% | 20% | 60%).</p>

                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="sim-subject" class="block text-sm font-medium text-gray-700">Mati√®re √† simuler</label>
                                <select id="sim-subject" class="prediction-input"></select>
                            </div>
                            <div>
                                <label for="sim-target-grade" class="block text-sm font-medium text-gray-700">Objectif de note finale (%)</label>
                                <input type="number" id="sim-target-grade" class="prediction-input" value="85" min="50" max="100">
                            </div>
                            <div>
                                <label for="sim-etape-2-avg" class="block text-sm font-medium text-gray-700">Moyenne √âtape 2 (Actuelle)</label>
                                <input type="text" id="sim-etape-2-avg" class="prediction-input bg-gray-200" readonly>
                            </div>
                        </div>
                        <button id="run-simulation" class="bg-primary-color text-white px-6 py-2 rounded-md hover:bg-blue-700 transition font-semibold w-full">Lancer la Simulation</button>
                    </div>

                    <div id="simulation-result" class="mt-6 p-6 rounded-lg border-2 border-dashed hidden">
                        <!-- Simulation results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Unit Customization -->
    <div id="unites-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Unit√©s par Mati√®re</h3>
            <p class="text-sm text-gray-500 mb-4">Ajustez les unit√©s pour chaque mati√®re si le mode 'Personnalis√©' est s√©lectionn√©.</p>
            <div id="unites-list" class="max-h-80 overflow-y-auto border p-3 rounded-md space-y-2">
                <!-- Units will be populated here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-unites-modal" class="bg-primary-color text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Fermer & Appliquer</button>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONSTANTS AND STATE ---
    const gradeMap = { 'A+': 100, 'A': 95, 'A-': 90, 'B+': 85, 'B': 80, 'B-': 75, 'C+': 70, 'C': 65, 'C-': 60, 'D+': 55, 'D': 50, 'E': 45 };
    const defaultUnits = {
        sec4: { 'ART': 2, 'MUS': 2, 'DRM': 2, 'FRA': 6, 'ELA': 4, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 6, 'ST': 4, 'STE': 4, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'ENT': 2, 'INF': 2, 'PSY': 2 },
        sec5: { 'ART': 2, 'MUS': 2, 'DRM': 2, 'CAT': 4, 'FRA': 6, 'ELA': 6, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 4, 'MED': 4, 'PSY': 4, 'ENT': 4, 'FIN': 4, 'CHI': 4, 'PHY': 4, 'MON': 2, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'FIN': 2 }
    };
    const subjectList = { 'ART': "Arts Plastiques", 'MUS': "Musique", 'DRM': "Art Dramatique", 'CAT': "Conception et Application Technologique", 'FRA': "Fran√ßais", 'ELA': "English Language Arts", 'EESL': "Enriched English", 'ESL': "English Second Language", 'SN': "Math SN", 'CST': "Math CST", 'ST': "Science et Technologie", 'STE': "Science et Tech. Env.", 'HQC': "Histoire", 'CCQ': "Culture et Citoyennet√©", 'EPS': "√âducation Physique", 'CHI': "Chimie", 'PHY': "Physique", 'MON': "Monde Contemporain", 'MED': "M√©dia", 'ENT': "Entrepreneuriat", 'INF': "Informatique", 'PSY': "Psychologie", 'FIN': "√âducation Financi√®re" };
    
    let mbsData = {};
    let activeTab = 'etape1';
    let cachedAverages = null;

    // --- INITIALIZATION ---
    function init() {
        mbsData = JSON.parse(localStorage.getItem('mbsData')) || {};

        if (!mbsData.valid || !mbsData.nom) {
            const mainContainer = document.querySelector('.main-container');
            if (mainContainer) {
                mainContainer.innerHTML = `<p style="text-align:center; width:100%; padding: 4rem;">Aucune donn√©e disponible. Veuillez vous assurer que les donn√©es sont enregistr√©es dans 'mbsData' dans le Local Storage.</p>`;
            }
            return;
        }

        loadSettings();
        calculateAndCacheAverages();
        renderAll();
        populateSimSubjectDropdown();
        setupEventListeners();
    }

    // --- DATA & SETTINGS MANAGEMENT ---
    function loadSettings() {
        const settings = mbsData.settings || {};
        const niveauEl = document.getElementById('niveau-secondaire');
        const unitesModeEl = document.getElementById('unites-mode');

        if (niveauEl) niveauEl.value = settings.niveau || '';
        if (unitesModeEl) unitesModeEl.value = settings.unitesMode || 'defaut';
    }

    function saveSettings() {
        const niveauEl = document.getElementById('niveau-secondaire');
        const unitesModeEl = document.getElementById('unites-mode');

        mbsData.settings = mbsData.settings || {};
        mbsData.settings.niveau = niveauEl ? niveauEl.value : '';
        mbsData.settings.unitesMode = unitesModeEl ? unitesModeEl.value : 'defaut';
        mbsData.settings.customUnites = mbsData.settings.customUnites || {};
        
        localStorage.setItem('mbsData', JSON.stringify(mbsData));
        calculateAndCacheAverages();
        renderAll();
    }
    
    function saveCustomUnits() {
        const unitesModeEl = document.getElementById('unites-mode');
        if (!unitesModeEl || unitesModeEl.value !== 'perso') return;

        let customUnites = {};
        document.querySelectorAll('.unite-item input').forEach(input => {
            customUnites[input.dataset.code] = parseFloat(input.value) || 1;
        });
        
        mbsData.settings = mbsData.settings || {};
        mbsData.settings.customUnites = customUnites;
        saveSettings();
    }

    function savePonderations() {
        document.querySelectorAll('.pond-input-field.modified-input').forEach(input => {
            const [etapeKey, subjectIndex, compIndex, assignIndex] = input.dataset.path.split('-');
            if (mbsData[etapeKey] && mbsData[etapeKey][subjectIndex] && mbsData[etapeKey][subjectIndex].competencies[compIndex] && mbsData[etapeKey][subjectIndex].competencies[compIndex].assignments[assignIndex]) {
                mbsData[etapeKey][subjectIndex].competencies[compIndex].assignments[assignIndex].pond = input.value;
                input.classList.remove('modified-input');
            }
        });
        localStorage.setItem('mbsData', JSON.stringify(mbsData));
        calculateAndCacheAverages();
        renderAll(); // Re-render to remove highlights and update analysis
    }

    // --- RENDERING FUNCTIONS ---
    function renderAll() {
        renderTermTables();
        const averages = cachedAverages;
        renderSidePanel(averages);
        renderDeepAnalysis(averages);

        const ponderationControls = document.getElementById('ponderation-controls');
        if (ponderationControls) {
            // Check if any pond input still has the modified-input class
            const isModified = document.querySelector('.pond-input-field.modified-input') !== null;
            ponderationControls.classList.toggle('hidden', !isModified);
        }
    }

    function renderTermTables() {
        const etape1El = document.getElementById('etape1');
        const etape2El = document.getElementById('etape2');
        const etape3El = document.getElementById('etape3');
        const averages = cachedAverages;
        
        if (etape1El) renderTermData(mbsData.etape1, etape1El, 'etape1', averages);
        if (etape2El) renderTermData(mbsData.etape2, etape2El, 'etape2', averages);
        if (etape3El) renderTermData(mbsData.etape3, etape3El, 'etape3', averages);
    }

    function renderTermData(termData, container, etapeKey, averages) {
        if (!container) return; 

        if (!termData || termData.length === 0) {
            container.innerHTML = '<p class="no-data">Aucune donn√©e pour cette √©tape.</p>';
            return;
        }
        container.innerHTML = '';
        termData.forEach((subject, subjectIndex) => {
            container.appendChild(renderSubjectTable(subject, etapeKey, subjectIndex));
            const codePrefix = subject.code.substring(0, 3);
            container.appendChild(renderSubjectAnalysis(codePrefix, etapeKey, averages));
        });
    }

    function renderSubjectTable(subject, etapeKey, subjectIndex) {
        const table = document.createElement('table');
        table.className = 'subject-table';
        const codePrefix = subject.code.substring(0, 3);
        const subjectName = subjectList[codePrefix] || subject.name;
        
        table.innerHTML = `
            <thead>
                <tr><th colspan="7">${codePrefix} - ${subjectName}</th></tr>
                <tr><th>Cat√©gorie</th><th>Travail</th><th>Pond.</th><th>Date assign√©e</th><th>Date due</th><th>R√©sultat</th></tr>
            </thead>
            <tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        subject.competencies.forEach((comp, compIndex) => {
            const compRow = document.createElement('tr');
            compRow.className = 'competency-row';
            compRow.innerHTML = `<td colspan="7">${comp.name}</td>`;
            if (tbody) tbody.appendChild(compRow);

            comp.assignments.forEach((assign, assignIndex) => {
                const assignRow = document.createElement('tr');
                const dataPath = `${etapeKey}-${subjectIndex}-${compIndex}-${assignIndex}`;
                const originalPond = mbsData[etapeKey]?.[subjectIndex]?.competencies?.[compIndex]?.assignments?.[assignIndex]?.pond;
                const pondClass = (assign.pond || '') !== originalPond ? 'modified-input' : '';
                
                assignRow.innerHTML = `
                    <td>${assign.category || '<span class="no-data">-</span>'}</td>
                    <td>${assign.work || '<span class="no-data">-</span>'}</td>
                    <td><input type="number" class="pond-input-field ${pondClass}" value="${assign.pond || ''}" data-path="${dataPath}" placeholder="--"></td>
                    <td>${assign.assignedDate || '<span class="no-data">-</span>'}</td>
                    <td>${(assign.dueDate || '').replace('√†','')}</td>
                    <td>
                        <div class="grade-container" data-original-result="${assign.result || ''}">
                            <span class="grade-display">${formatGrade(assign.result)}</span>
                            <input type="number" class="grade-input-field hidden" min="0" max="100">
                        </div>
                    </td>
                `;
                if (tbody) tbody.appendChild(assignRow);
            });
        });
        return table;
    }

    function renderSubjectAnalysis(subjectCode, etapeKey, averages) {
        const analysisDiv = document.createElement('div');
        analysisDiv.className = 'subject-analysis';
        
        const subjAvgData = averages.subjectAverages[etapeKey]?.[subjectCode];
        const currentAvg = subjAvgData?.average;

        if (currentAvg === null || currentAvg === undefined) {
            analysisDiv.innerHTML = `<p class="text-sm text-gray-500">Aucune note pour l'analyse de ${subjectList[subjectCode]}.</p>`;
            return analysisDiv;
        }

        const stats = calculateSubjectStatistics(subjAvgData.data, etapeKey);

        // 1. Consistency/Effort Badge
        let consistencyBadge = { label: 'Inconnu', class: 'badge-yellow', icon: '‚ùì' };
        if (stats.consistencyScore !== null) {
            if (stats.consistencyScore >= 85) consistencyBadge = { label: '√âlev√©', class: 'badge-green', icon: '‚úÖ' };
            else if (stats.consistencyScore >= 60) consistencyBadge = { label: 'Mod√©r√©', class: 'badge-yellow', icon: '‚ö†Ô∏è' };
            else consistencyBadge = { label: 'Faible', class: 'badge-red', icon: '‚ùå' };
        }
        
        // 2. Trend Badge (Only for Etape 2 & 3)
        let trendBadge = { label: 'N/A', class: 'bg-gray-200 text-gray-600', icon: ' ' };
        let trendDescription = '';

        if (etapeKey !== 'etape1') {
            const prevEtape = etapeKey === 'etape2' ? 'etape1' : 'etape2';
            const prevAvg = averages.subjectAverages[prevEtape]?.[subjectCode]?.average;

            if (prevAvg !== undefined && prevAvg !== null) {
                const diff = currentAvg - prevAvg;
                const absDiff = Math.abs(diff);

                if (diff > 2) {
                    trendBadge = { label: `Hausse (+${absDiff.toFixed(1)}%)`, class: 'badge-green', icon: '‚¨ÜÔ∏è' };
                    trendDescription = 'La note est en nette am√©lioration, bravo !';
                } else if (diff < -2) {
                    trendBadge = { label: `Baisse (${diff.toFixed(1)}%)`, class: 'badge-red', icon: '‚¨áÔ∏è' };
                    trendDescription = 'La note est en baisse. Une analyse de l\'effort est recommand√©e.';
                } else {
                    trendBadge = { label: 'Stable', class: 'badge-yellow', icon: '‚ÜîÔ∏è' };
                    trendDescription = 'La note est stable par rapport √† la derni√®re √©tape.';
                }
            }
        } else {
            trendDescription = 'Analyse de tendance disponible apr√®s l\'√âtape 2.';
        }

        // 3. Overall Diagnostic
        let diagnostic = `La moyenne de cette √©tape est de <strong>${currentAvg.toFixed(2)}%</strong>. `;
        diagnostic += `Le score de consistance (${stats.consistencyScore.toFixed(0)}/100) indique un travail ${consistencyBadge.label.toLowerCase()} entre les √©valuations.`;
        if (trendDescription) {
            diagnostic += ` ${trendDescription}`;
        }
        if (stats.highVariationCompetency) {
            diagnostic += ` Le plus grand √©cart se situe dans la comp√©tence: <strong>${stats.highVariationCompetency}</strong>.`;
        }

        analysisDiv.innerHTML = `
            <div class="flex items-center mb-2">
                <span class="text-lg font-semibold text-gray-800 mr-4">Diagnostic Rapide pour ${subjectList[subjectCode]}</span>
                <span class="analysis-badge ${consistencyBadge.class}">${consistencyBadge.icon} Consistance: ${stats.consistencyScore.toFixed(0)}/100</span>
                <span class="analysis-badge ${trendBadge.class}">${trendBadge.icon} Tendance: ${trendBadge.label}</span>
            </div>
            <p class="text-sm text-gray-700">${diagnostic}</p>
        `;

        return analysisDiv;
    }


    function renderSidePanel(averages) {
        const formatAvg = (avg) => avg !== null ? `<span class="grade-percentage">${avg.toFixed(2)}%</span>` : '--';

        const globalAvgEl = document.getElementById('moyenne-generale');
        if (globalAvgEl) {
            globalAvgEl.innerHTML = formatAvg(averages.globalAverage);
            globalAvgEl.classList.toggle('invalid', averages.globalAverage === null && !!mbsData.etape1);
        }

        const etapeNameEl = document.getElementById('active-etape-name');
        if (etapeNameEl) {
            etapeNameEl.textContent = activeTab.replace('etape', '');
        }

        const termAvgEl = document.getElementById('moyenne-etape');
        if (termAvgEl) {
            termAvgEl.innerHTML = formatAvg(averages.termAverages[activeTab]);
        }

        const subjectListEl = document.getElementById('subject-averages-list');
        if (subjectListEl) {
            subjectListEl.innerHTML = '';
            const activeTermSubjects = averages.subjectAverages[activeTab];
            if (activeTermSubjects && Object.keys(activeTermSubjects).length > 0) {
                Object.entries(activeTermSubjects).forEach(([code, subj]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between';
                    li.innerHTML = `<span>${subj.name}</span><strong>${formatAvg(subj.average)}</strong>`;
                    subjectListEl.appendChild(li);
                });
            } else {
                subjectListEl.innerHTML = '<li class="no-data">Aucune mati√®re pour cette √©tape</li>';
            }
        }
    }

    function renderDeepAnalysis(averages) {
        const scorecard = calculatePerformanceScorecard(averages);
        
        const consistencyEl = document.getElementById('consistency-score');
        if (consistencyEl) {
            consistencyEl.className = 'score-card'; // Reset classes
            consistencyEl.querySelector('strong').textContent = scorecard.consistencyScore.toFixed(0) + ' / 100';
            if (scorecard.consistencyScore < 60) consistencyEl.classList.add('score-low');
            else if (scorecard.consistencyScore < 85) consistencyEl.classList.add('score-medium');
            else consistencyEl.classList.add('score-high');
        }

        const riskEl = document.getElementById('workload-risk');
        if (riskEl) {
            riskEl.className = 'score-card'; // Reset classes
            riskEl.querySelector('strong').textContent = scorecard.workloadRisk.label;
            if (scorecard.workloadRisk.level === 'High') riskEl.classList.add('score-low');
            else if (scorecard.workloadRisk.level === 'Medium') riskEl.classList.add('score-medium');
            else riskEl.classList.add('score-high');
        }

        const predictionEl = document.getElementById('prediction-score');
        if (predictionEl) {
            predictionEl.querySelector('strong').textContent = scorecard.predictedFinalAvg !== null 
                ? `${scorecard.predictedFinalAvg.toFixed(2)}%` 
                : '--';
            predictionEl.className = 'score-card';
            if (scorecard.predictedFinalAvg !== null) {
                if (scorecard.predictedFinalAvg < 75) predictionEl.classList.add('score-low');
                else if (scorecard.predictedFinalAvg < 85) predictionEl.classList.add('score-medium');
                else predictionEl.classList.add('score-high');
            } else {
                predictionEl.classList.add('score-low');
            }
        }
    }

    function populateSimSubjectDropdown() {
        const select = document.getElementById('sim-subject');
        if (!select) return;

        select.innerHTML = '<option value="">-- S√©lectionner une mati√®re --</option>';

        const subjectCodes = new Set();
        ['etape1', 'etape2', 'etape3'].forEach(etapeKey => {
            mbsData[etapeKey]?.forEach(subject => {
                const codePrefix = subject.code.substring(0, 3);
                subjectCodes.add(codePrefix);
            });
        });

        const sortedCodes = Array.from(subjectCodes).sort();
        sortedCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${subjectList[code] || code} (${code})`;
            select.appendChild(option);
        });

        // Add listener to update Etape 2 Avg display
        select.addEventListener('change', updateSimEtape2Avg);
    }
    
    function updateSimEtape2Avg() {
        const subjectCode = document.getElementById('sim-subject')?.value;
        const etape2AvgInput = document.getElementById('sim-etape-2-avg');
        
        if (!etape2AvgInput) return;

        const averages = cachedAverages;
        const subjectAverages = averages.subjectAverages['etape2'] || {};
        
        if (subjectCode && subjectAverages[subjectCode] && subjectAverages[subjectCode].average !== null) {
            etape2AvgInput.value = subjectAverages[subjectCode].average.toFixed(2) + '%';
        } else {
            etape2AvgInput.value = 'N/D';
        }
    }

    // --- CALCULATION LOGIC ---
    function getNumericGrade(result) {
        if (!result) return null;
        const trimmed = result.trim();
        if (gradeMap[trimmed]) return gradeMap[trimmed];
        
        const percentageMatch = trimmed.match(/(\d+[,.]?\d*)\s*%/);
        if (percentageMatch) return parseFloat(percentageMatch[1].replace(',', '.'));

        const scoreMatch = trimmed.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);
        if (scoreMatch) {
            const score = parseFloat(scoreMatch[1].replace(',', '.'));
            const max = parseFloat(scoreMatch[2].replace(',', '.'));
            return (max > 0) ? (score / max) * 100 : null;
        }
        return null;
    }
    
    function getUnits() {
        const { niveau, unitesMode, customUnites } = mbsData.settings || {};
        if (unitesMode === 'sans') return new Proxy({}, { get: () => 1 });
        if (unitesMode === 'perso') return customUnites || {};
        return (niveau && defaultUnits[niveau]) ? defaultUnits[niveau] : {};
    }
    
    function calculateAndCacheAverages() {
        cachedAverages = calculateAllAverages();
    }

    function calculateSubjectAverage(subject, etapeKey, subjectIndex) {
        let totalWeightedGrade = 0;
        let totalCompetencyWeight = 0;

        subject.competencies.forEach((comp, compIndex) => {
            const compWeightMatch = comp.name.match(/\((\d+)%\)/);
            const compWeight = compWeightMatch ? parseFloat(compWeightMatch[1]) : 0;
            if (compWeight === 0) return;

            let totalAssignmentGrade = 0;
            let totalAssignmentWeight = 0;

            comp.assignments.forEach((assign, assignIndex) => {
                const dataPath = `${etapeKey}-${subjectIndex}-${compIndex}-${assignIndex}`;
                const pondInput = document.querySelector(`.pond-input-field[data-path="${dataPath}"]`);
                const gradeContainer = pondInput ? pondInput.closest('tr')?.querySelector('.grade-container') : null;
                const gradeInput = gradeContainer?.querySelector('.grade-input-field');

                let grade = null;
                // Use the manual input if it's visible and populated
                if (gradeInput && !gradeInput.classList.contains('hidden') && gradeInput.value.trim() !== '') {
                    grade = parseFloat(gradeInput.value);
                } else {
                    grade = getNumericGrade(assign.result);
                }

                let weight = parseFloat(pondInput?.value || assign.pond || 0);

                if (grade !== null && !isNaN(grade) && !isNaN(weight) && weight > 0) {
                    totalAssignmentGrade += grade * weight;
                    totalAssignmentWeight += weight;
                }
            });

            if (totalAssignmentWeight > 0) {
                const competencyAverage = totalAssignmentGrade / totalAssignmentWeight;
                totalWeightedGrade += competencyAverage * (compWeight / 100);
                totalCompetencyWeight += (compWeight / 100);
            }
        });

        return totalCompetencyWeight > 0 ? (totalWeightedGrade / totalCompetencyWeight) : null;
    }

    function calculateSubjectStatistics(subject, etapeKey) {
        let allGrades = [];
        let compAverages = [];
        let highVariationCompetency = null;
        let maxCompStdDev = 0;

        subject.competencies.forEach(comp => {
            let compGrades = [];
            comp.assignments.forEach(assign => {
                const grade = getNumericGrade(assign.result);
                if (grade !== null) {
                    allGrades.push(grade);
                    compGrades.push(grade);
                }
            });

            if (compGrades.length >= 2) {
                const mean = compGrades.reduce((a, b) => a + b) / compGrades.length;
                const variance = compGrades.reduce((sum, grade) => sum + Math.pow(grade - mean, 2), 0) / compGrades.length;
                const stdDev = Math.sqrt(variance);

                if (stdDev > maxCompStdDev) {
                    maxCompStdDev = stdDev;
                    highVariationCompetency = comp.name.split('(')[0].trim();
                }
            }
        });

        let consistencyScore = null;
        if (allGrades.length >= 2) {
            const mean = allGrades.reduce((a, b) => a + b) / allGrades.length;
            const variance = allGrades.reduce((sum, grade) => sum + Math.pow(grade - mean, 2), 0) / allGrades.length;
            const stdDev = Math.sqrt(variance);
            // Formula: 100 - (SD * 3). SD of 10 means 70 score.
            consistencyScore = Math.max(0, 100 - (stdDev * 3));
        }

        return { consistencyScore, highVariationCompetency };
    }


    function calculateAllAverages() {
        const units = getUnits();
        const niveau = mbsData.settings?.niveau;
        let allTermAverages = { etape1: null, etape2: null, etape3: null };
        let allSubjectAverages = {};
        let allGradesGlobal = [];

        ['etape1', 'etape2', 'etape3'].forEach(etape => {
            if (!mbsData[etape]) return;
            let termWeightedSum = 0;
            let termUnitSum = 0;
            allSubjectAverages[etape] = {};

            mbsData[etape].forEach((subject, subjectIndex) => {
                const average = calculateSubjectAverage(subject, etape, subjectIndex);
                const codePrefix = subject.code.substring(0, 3);
                
                // Collect all assignment grades for global consistency score
                subject.competencies.forEach(comp => {
                    comp.assignments.forEach(assign => {
                        const grade = getNumericGrade(assign.result);
                        if (grade !== null) allGradesGlobal.push(grade);
                    });
                });
                
                // Store subject average and data
                allSubjectAverages[etape][codePrefix] = { 
                    name: subjectList[codePrefix] || subject.name, 
                    average, 
                    data: subject // Full subject data for statistics
                };

                if (average !== null && niveau) {
                    const unit = units[codePrefix] || 2;
                    termWeightedSum += average * unit;
                    termUnitSum += unit;
                }
            });
            allTermAverages[etape] = termUnitSum > 0 ? termWeightedSum / termUnitSum : null;
        });

        let globalWeightedSum = 0;
        let totalWeight = 0;
        const termWeights = { etape1: 0.20, etape2: 0.20, etape3: 0.60 };
        Object.entries(allTermAverages).forEach(([etape, avg]) => {
            if (avg !== null) {
                globalWeightedSum += avg * termWeights[etape];
                totalWeight += termWeights[etape];
            }
        });

        const globalAverage = totalWeight > 0 ? globalWeightedSum / totalWeight : null;
        return { subjectAverages: allSubjectAverages, termAverages: allTermAverages, globalAverage, allGradesGlobal };
    }

    function calculatePerformanceScorecard(averages) {
        const { termAverages, allGradesGlobal } = averages;
        const units = getUnits();
        const niveau = mbsData.settings?.niveau;
        const termWeights = { etape1: 0.20, etape2: 0.20, etape3: 0.60 };

        // 1. Consistency / Effort Index (based on Standard Deviation of ALL grades)
        let consistencyScore = 100;
        if (allGradesGlobal.length >= 2) {
            const mean = allGradesGlobal.reduce((a, b) => a + b) / allGradesGlobal.length;
            const variance = allGradesGlobal.reduce((sum, grade) => sum + Math.pow(grade - mean, 2), 0) / allGradesGlobal.length;
            const stdDev = Math.sqrt(variance);

            // Penalize high standard deviation (inconsistency). Max SD penalty set around 50 points
            // Formula: 100 - (SD * 2). SD of 15 means 70 score. SD of 25 means 50 score.
            consistencyScore = Math.max(0, 100 - (stdDev * 2));
        }

        // 2. Workload / Burnout Risk
        let totalUnits = 0;
        let gradeDrop = 0;
        
        if (niveau) {
            // Calculate total units
            Object.keys(units).forEach(code => {
                totalUnits += units[code] || 0;
            });
        }
        
        if (termAverages.etape1 !== null && termAverages.etape2 !== null) {
            gradeDrop = termAverages.etape1 - termAverages.etape2;
        }

        let workloadRisk = { level: 'Low', label: 'Faible' };
        if (totalUnits > 30 && niveau) {
            workloadRisk = { level: 'Medium', label: 'Mod√©r√© (Charge √©lev√©e)' };
        }
        if (totalUnits > 30 && gradeDrop > 5 && niveau) {
            workloadRisk = { level: 'High', label: '√âlev√© (Charge + Baisse)' };
        } else if (gradeDrop > 8) {
             workloadRisk = { level: 'High', label: '√âlev√© (Baisse significative)' };
        }
        
        // 3. Predicted Final Average (assuming Etape 3 = Etape 2 avg)
        let predictedFinalAvg = null;
        const avg1 = termAverages.etape1;
        const avg2 = termAverages.etape2;
        const totalKnownWeight = (avg1 !== null ? termWeights.etape1 : 0) + (avg2 !== null ? termWeights.etape2 : 0) + (termAverages.etape3 !== null ? termWeights.etape3 : 0);
        let currentAvgSum = (avg1 !== null ? avg1 * termWeights.etape1 : 0) + (avg2 !== null ? avg2 * termWeights.etape2 : 0) + (termAverages.etape3 !== null ? termAverages.etape3 * termWeights.etape3 : 0);

        if (avg2 !== null) {
            // Predict Etape 3 = Etape 2
            predictedFinalAvg = (currentAvgSum + (avg2 * termWeights.etape3)) / (totalKnownWeight + termWeights.etape3);
            if (termAverages.etape3 !== null) predictedFinalAvg = (currentAvgSum) / (totalKnownWeight); // If etape 3 is there, just use actual global avg
        } else if (avg1 !== null) {
            // If only Etape 1 is available, predict Etape 2 and 3 equal Etape 1
            predictedFinalAvg = avg1; // (avg1 * (w1+w2+w3)) / (w1+w2+w3)
        }


        return { consistencyScore, workloadRisk, predictedFinalAvg };
    }

    function simulateFinalGrade() {
        const subjectCode = document.getElementById('sim-subject')?.value;
        const targetFinalGrade = parseFloat(document.getElementById('sim-target-grade')?.value);
        const resultEl = document.getElementById('simulation-result');
        const averages = cachedAverages;

        if (!subjectCode || isNaN(targetFinalGrade) || targetFinalGrade <= 0) {
            if (resultEl) {
                resultEl.innerHTML = '<p class="text-red-500 font-semibold">Veuillez s√©lectionner une mati√®re et d√©finir un objectif valide.</p>';
                resultEl.classList.remove('hidden');
            }
            return;
        }
        
        const subjAvgs = averages.subjectAverages;
        
        const avg1 = subjAvgs.etape1?.[subjectCode]?.average;
        const avg2 = subjAvgs.etape2?.[subjectCode]?.average;

        const w1 = 0.20; // Etape 1 weight
        const w2 = 0.20; // Etape 2 weight
        const w3 = 0.60; // Etape 3 weight

        let requiredAvg3 = null;
        let outputMessage = '';

        if (avg1 === null && avg2 === null) {
            // No data at all
            outputMessage = `<p class="text-red-500 font-semibold">Simulation impossible : Aucune donn√©e disponible pour cette mati√®re.</p>`;
        } else if (avg1 !== null && avg2 !== null) {
            // Full data for Etape 1 and 2
            requiredAvg3 = (targetFinalGrade - (avg1 * w1) - (avg2 * w2)) / w3;
            const status = requiredAvg3 > 100 ? 'impossible' : (requiredAvg3 < 50 ? 'facile' : (requiredAvg3 > 90 ? 'difficile' : 'faisable'));
            let color = requiredAvg3 > 100 ? 'text-red-600' : (requiredAvg3 < 50 ? 'text-green-600' : (requiredAvg3 > 90 ? 'text-yellow-600' : 'text-blue-600'));
            
            if (requiredAvg3 > 100) requiredAvg3 = "Impossible";

            outputMessage = `
                <h3 class="text-xl font-bold mb-2">R√©sultat de la Simulation pour ${subjectList[subjectCode]}:</h3>
                <ul class="list-disc ml-5 space-y-1">
                    <li>Moyenne √âtape 1: <strong>${avg1.toFixed(2)}%</strong> (Pond. ${w1*100}%)</li>
                    <li>Moyenne √âtape 2: <strong>${avg2.toFixed(2)}%</strong> (Pond. ${w2*100}%)</li>
                    <li>Objectif Final: <strong>${targetFinalGrade.toFixed(0)}%</strong></li>
                </ul>
                <p class="mt-4 text-lg font-semibold ${color}">
                    Moyenne Minimale Requise √† l'√âtape 3: 
                    <span class="text-2xl">${typeof requiredAvg3 === 'number' ? requiredAvg3.toFixed(2) + '%' : requiredAvg3}</span>
                </p>
                <p class="mt-2 text-sm text-gray-700">
                    Ce sc√©nario est <strong>${status}</strong>. ${requiredAvg3 === "Impossible" ? 'Atteindre cet objectif est math√©matiquement impossible avec vos notes actuelles.' : 'Concentrez-vous sur les travaux de l\'√âtape 3.'}
                </p>
            `;
        } else if (avg1 !== null || avg2 !== null) {
            // Partial data (only Etape 1 or Etape 2)
            const currentAvg = avg2 !== null ? avg2 : avg1;
            const currentWeight = avg2 !== null ? w2 : w1;
            
            // Assume missing term average is equal to the current average, 
            // then calculate required Etape 3 average. This is a best-effort estimation.
            const estimatedAvg3 = (targetFinalGrade - (currentAvg * (w1 + w2))) / w3;

             outputMessage = `
                <h3 class="text-xl font-bold mb-2">R√©sultat de la Simulation pour ${subjectList[subjectCode]}:</h3>
                <p class="text-yellow-600 mb-4 font-semibold">Attention: Simulation avec donn√©es partielles. L'√âtape ${avg2 !== null ? '1' : '2'} manque. Estimation prudente utilis√©e.</p>
                <ul class="list-disc ml-5 space-y-1">
                    <li>Moyenne connue (√âtape ${avg2 !== null ? '2' : '1'}): <strong>${currentAvg.toFixed(2)}%</strong></li>
                    <li>Objectif Final: <strong>${targetFinalGrade.toFixed(0)}%</strong></li>
                </ul>
                <p class="mt-4 text-lg font-semibold">
                    Moyenne Estim√©e Requise √† l'√âtape 3: 
                    <span class="text-2xl">${estimatedAvg3.toFixed(2)}%</span>
                </p>
            `;
        }

        if (resultEl) {
            resultEl.innerHTML = outputMessage;
            resultEl.classList.remove('hidden');
        }
    }


    // --- UTILITY & FORMATTING ---
    function formatGrade(result) {
        if (!result) return '<span class="no-data">-</span>';
        const numGrade = getNumericGrade(result);
        if (numGrade === null) return result;

        const trimmedResult = result.trim();
        const isLetterGrade = !!gradeMap[trimmedResult];
        const scoreMatch = trimmedResult.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);
        const percentMatch = trimmedResult.match(/(\d+[,.]?\d*)\s*%/);

        if (isLetterGrade) {
            return `${trimmedResult} <i>(~<span class="grade-percentage">${numGrade.toFixed(1)}%</span>)</i>`;
        }
        if (scoreMatch) {
            return `<span>${scoreMatch[0]}</span> <span class="grade-percentage">${numGrade.toFixed(1)}%</span>`;
        }
        if (percentMatch) {
            return `<span class="grade-percentage">${trimmedResult}</span>`;
        }
        
        return `<span class="grade-percentage">${numGrade.toFixed(1)}%</span>`; // Catch-all for numeric strings
    }
    
    function populateUnitesModal() {
        const unitesListEl = document.getElementById('unites-list');
        if (!unitesListEl) return;
        
        unitesListEl.innerHTML = '';

        const currentUnits = getUnits();
        const subjectCodes = new Set();

        ['etape1', 'etape2', 'etape3'].forEach(etapeKey => {
            mbsData[etapeKey]?.forEach(subject => {
                const codePrefix = subject.code.substring(0, 3);
                subjectCodes.add(codePrefix);
            });
        });

        Array.from(subjectCodes).sort().forEach(code => {
            const currentUnitValue = currentUnits[code] || 1;
            const li = document.createElement('div');
            li.className = 'unite-item';
            li.innerHTML = `
                <span>${subjectList[code] || code} (${code})</span>
                <input type="number" class="w-20 text-right p-1 border rounded-md" value="${currentUnitValue}" min="0" max="10" data-code="${code}">
            `;
            unitesListEl.appendChild(li);
        });
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Tabs
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelector('.tab-btn.active')?.classList.remove('active');
                tab.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                activeTab = tab.dataset.tab;
                document.getElementById(activeTab)?.classList.add('active');
                
                renderSidePanel(cachedAverages);
            });
        });

        // Settings
        document.getElementById('niveau-secondaire')?.addEventListener('change', saveSettings);
        document.getElementById('unites-mode')?.addEventListener('change', () => {
            saveSettings();
            populateUnitesModal();
        });

        // Simulation
        document.getElementById('run-simulation')?.addEventListener('click', simulateFinalGrade);
        document.getElementById('sim-subject')?.addEventListener('change', updateSimEtape2Avg);

        // Modals
        const unitesModal = document.getElementById('unites-modal');
        document.getElementById('unites-btn')?.addEventListener('click', () => {
            populateUnitesModal();
            unitesModal?.classList.add('active');
        });
        document.getElementById('close-unites-modal')?.addEventListener('click', () => {
            saveCustomUnits();
            unitesModal?.classList.remove('active');
        });

        // Ponderation controls
        document.getElementById('save-ponds-btn')?.addEventListener('click', savePonderations);
        document.getElementById('revert-ponds-btn')?.addEventListener('click', renderAll);

        // Dynamic content listeners (Event Delegation)
        const tabContents = document.getElementById('tab-contents');
        
        if (tabContents) {
            // Input Listener for Ponderation and Custom Grades
            tabContents.addEventListener('input', e => {
                const target = e.target;
                const ponderationControls = document.getElementById('ponderation-controls');

                if (target.classList.contains('pond-input-field')) {
                    const [etapeKey, subjectIndex, compIndex, assignIndex] = target.dataset.path.split('-');
                    const originalPond = mbsData[etapeKey]?.[subjectIndex]?.competencies?.[compIndex]?.assignments?.[assignIndex]?.pond;
                    
                    target.classList.toggle('modified-input', target.value != originalPond);
                    if (ponderationControls) {
                        ponderationControls.classList.remove('hidden');
                    }
                    calculateAndCacheAverages();
                    renderSidePanel(cachedAverages);
                    renderDeepAnalysis(cachedAverages);
                    updateSimEtape2Avg();
                }
                if (target.classList.contains('grade-input-field')) {
                    calculateAndCacheAverages();
                    renderSidePanel(cachedAverages);
                    renderDeepAnalysis(cachedAverages);
                    renderTermTables(); // Re-render analysis for specific subject
                    updateSimEtape2Avg();
                }
            });

            // Click Listener to switch Grade Display to Input
            tabContents.addEventListener('click', e => {
                const gradeDisplay = e.target.closest('.grade-display');
                if (gradeDisplay) {
                    const container = gradeDisplay.closest('.grade-container');
                    const inputField = container?.querySelector('.grade-input-field');
                    const originalResult = container?.dataset.originalResult;
                    const numericGrade = getNumericGrade(originalResult);
                    
                    if (inputField) {
                        gradeDisplay.classList.add('hidden');
                        inputField.classList.remove('hidden');
                        inputField.value = numericGrade !== null ? numericGrade.toFixed(2) : '';
                        inputField.focus();
                        inputField.select();
                    }
                }
            });

            // Focusout Listener to hide Input if empty or on blur
            tabContents.addEventListener('focusout', e => {
                if (e.target.classList.contains('grade-input-field')) {
                    // If the input is empty or blurred, revert to display mode
                    if (e.target.value.trim() === '') {
                        e.target.classList.add('hidden');
                        e.target.previousElementSibling?.classList.remove('hidden');
                    }
                    calculateAndCacheAverages();
                    renderSidePanel(cachedAverages);
                    renderDeepAnalysis(cachedAverages);
                    renderTermTables(); // Re-render analysis for specific subject
                    updateSimEtape2Avg();
                }
            }, true); // Use capture phase for focusout to catch blur events

            // Keydown Listener for Enter/Escape in Grade Input
            tabContents.addEventListener('keydown', e => {
                if (e.target.classList.contains('grade-input-field') && (e.key === 'Enter' || e.key === 'Escape')) {
                    if (e.key === 'Escape') e.target.value = ''; // Clear on escape
                    e.target.blur(); // Trigger focusout
                }
            });
        }
    }

    // --- START THE APP ---
    init();
});
    </script>
</body>
</html>
