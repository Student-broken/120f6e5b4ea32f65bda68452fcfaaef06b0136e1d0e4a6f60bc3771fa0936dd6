<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Moyenne Pondérée</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --background-color: #f9fafb;
            --card-background: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: #1f2937;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px;
        }
        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 3fr 1fr;
                padding: 32px;
            }
        }
        .card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 24px;
        }

        /* Tabs */
        .tab-btn.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tables */
        .subject-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 24px;
            overflow-x: auto;
            display: block;
        }
        .subject-table thead th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            text-align: left;
        }
        .subject-table thead th:first-child { border-top-left-radius: 8px; }
        .subject-table thead th:last-child { border-top-right-radius: 8px; }
        .subject-table tbody tr:nth-child(even) { background-color: #f3f4f6; }
        .subject-table tbody tr:hover { background-color: #e5e7eb; }
        .subject-table td, .subject-table th {
            padding: 10px 16px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .subject-table tbody tr:last-child td { border-bottom: none; }

        .competency-row td {
            background-color: #eef2ff !important;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Inputs */
        .pond-input-field {
            width: 50px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px;
        }
        .pond-input-field.modified-input {
            border-color: var(--secondary-color);
            background-color: #ecfdf5; /* green-50 */
        }
        .grade-percentage {
            font-weight: 700;
            color: var(--secondary-color);
        }
        .no-data {
            color: #9ca3af;
            font-style: italic;
        }
        .invalid {
            color: #ef4444; /* red-500 */
        }

        /* Grade Input Container (for real-time calculation) */
        .grade-container {
            position: relative;
            cursor: pointer;
        }
        .grade-input-field {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0 4px;
            text-align: center;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        .hidden { display: none !important; }

        /* Sidebar & Modals */
        .avg-large {
            font-size: 2.25rem; /* 3xl */
            font-weight: 700;
            color: var(--primary-color);
        }
        #subject-averages-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 50;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .unite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .unite-item input {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">MBS Grade Projections</h1>
            <p id="student-name" class="text-lg text-gray-600"></p>
        </div>
    </header>

    <div class="main-container">
        <!-- Main Content Area -->
        <div class="content-panel">
            <div class="card p-4 sm:p-6">
                <!-- Tab Controls -->
                <div class="flex border-b border-gray-200 space-x-4 mb-6">
                    <button data-tab="etape1" class="tab-btn active pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Étape 1 (20%)</button>
                    <button data-tab="etape2" class="tab-btn pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Étape 2 (20%)</button>
                    <button data-tab="etape3" class="tab-btn pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Étape 3 (60%)</button>
                </div>
                <!-- Ponderation Controls -->
                <div id="ponderation-controls" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg flex justify-between items-center">
                    <p class="text-sm text-yellow-700">Vous avez modifié des pondérations. Sauvegardez pour les appliquer de manière permanente.</p>
                    <div class="space-x-2">
                        <button id="revert-ponds-btn" class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Annuler</button>
                        <button id="save-ponds-btn" class="px-3 py-1 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">Sauvegarder</button>
                    </div>
                </div>
                <!-- Tab Contents -->
                <div id="tab-contents">
                    <div id="etape1" class="tab-content active"></div>
                    <div id="etape2" class="tab-content"></div>
                    <div id="etape3" class="tab-content"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar (Averages and Settings) -->
        <div class="sidebar space-y-6">
            <!-- Global Average Card -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-3">Moyenne Générale Projetée</h2>
                <div class="text-center">
                    <p id="moyenne-generale" class="avg-large">--</p>
                    <p class="text-gray-500">Pondération totale: Étape 1(20%) + Étape 2(20%) + Étape 3(60%)</p>
                </div>
            </div>

            <!-- Term Average Card -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-3">Moyenne de l'Étape Active</h2>
                <div class="text-center mb-4">
                    <p id="moyenne-etape" class="avg-large">--</p>
                </div>
                <h3 class="font-bold text-gray-700 mb-2 border-t pt-3">Moyennes par Matière (Unités Pondérées)</h3>
                <ul id="subject-averages-list" class="space-y-1"></ul>
            </div>

            <!-- Settings Card -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-3">Paramètres de Calcul</h2>
                <div class="space-y-4">
                    <div>
                        <label for="niveau-secondaire" class="block text-sm font-medium text-gray-700 mb-1">Niveau Secondaire</label>
                        <select id="niveau-secondaire" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Sélectionner...</option>
                            <option value="sec4">Secondaire 4</option>
                            <option value="sec5">Secondaire 5</option>
                        </select>
                    </div>
                    <div>
                        <label for="unites-mode" class="block text-sm font-medium text-gray-700 mb-1">Mode d'Unités</label>
                        <select id="unites-mode" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="defaut">Unités QEP (Défaut Sec. 4/5)</option>
                            <option value="perso">Unités Personnalisées</option>
                            <option value="sans">Sans Unités (Moyenne simple)</option>
                        </select>
                        <button id="unites-btn" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 disabled:opacity-50" disabled>Voir/Modifier Unités</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Units Customization Modal -->
    <div id="unites-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold">Unités par Matière</h2>
                <button id="close-unites-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Définissez les unités pour chaque matière. Ceci affecte la moyenne de l'étape.</p>
            <div id="unites-list" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Units will be populated here -->
            </div>
            <button id="save-unites-btn" class="w-full mt-6 py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 hidden">Sauvegarder Unités</button>
        </div>
    </div>


    <script>
        // --- START OF PROVIDED JAVASCRIPT LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONSTANTS AND STATE ---
            const gradeMap = { 'A+': 100, 'A': 95, 'A-': 90, 'B+': 85, 'B': 80, 'B-': 75, 'C+': 70, 'C': 65, 'C-': 60, 'D+': 55, 'D': 50, 'E': 45 };
            const defaultUnits = {
                'sec4': { 'ART': 2, 'MUS': 2, 'DRM': 2, 'FRA': 6, 'ELA': 4, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 6, 'ST': 4, 'STE': 4, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'ENT': 2, 'INF': 2, 'PSY': 2 },
                'sec5': { 'ART': 2, 'MUS': 2, 'DRM': 2, 'CAT': 4, 'FRA': 6, 'ELA': 6, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 4, 'MED': 4, 'PSY': 4, 'ENT': 4, 'FIN': 4, 'CHI': 4, 'PHY': 4, 'MON': 2, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'FIN': 2 }
            };
            const subjectList = { 'ART': "Arts Plastiques", 'MUS': "Musique", 'DRM': "Art Dramatique", 'CAT': "Conception et Application Technologique", 'FRA': "Français", 'ELA': "English Language Arts", 'EESL': "Anglais enrichi", 'ESL': "English Second Language", 'SN': "Math SN", 'CST': "Math CST", 'ST': "Science et Technologie", 'STE': "Science et Tech. Env.", 'HQC': "Histoire", 'CCQ': "Culture et Citoyenneté", 'EPS': "Éducation Physique", 'CHI': "Chimie", 'PHY': "Physique", 'MON': "Monde Contemporain", 'MED': "Média", 'ENT': "Entrepreneuriat", 'INF': "Informatique", 'PSY': "Psychologie", 'FIN': "Éducation Financière" };

            let mbsData = {};
            let activeTab = 'etape1';
            
            // --- DUMMY DATA FOR INITIAL LOAD ---
            const defaultMbsData = {
                nom: "Jean Tremblay",
                valid: true,
                settings: { niveau: 'sec5', unitesMode: 'defaut', customUnites: {} },
                etape1: [
                    // Subject 1: FRA (Français - 6 units Sec 5)
                    { code: 'FRA-5', name: 'Français Langue d\'Enseignement', competencies: [
                        { name: 'Comp. 1: Écrire des textes variés (40%)', assignments: [
                            { category: 'Écriture', work: 'Dissertation', pond: '10', assignedDate: '2025-09-05', dueDate: '2025-09-20', result: 'B+' },
                            { category: 'Écriture', work: 'Rapport lecture', pond: '5', assignedDate: '2025-10-01', dueDate: '2025-10-15', result: '80/100' }
                        ]},
                        { name: 'Comp. 2: Communiquer oralement (20%)', assignments: [
                            { category: 'Oral', work: 'Présentation', pond: '10', assignedDate: '2025-10-20', dueDate: '2025-10-30', result: 'A' }
                        ]},
                        { name: 'Comp. 3: Lire et apprécier (40%)', assignments: [
                            { category: 'Lecture', work: 'Examen', pond: '15', assignedDate: '2025-11-01', dueDate: '2025-11-15', result: '92%' }
                        ]}
                    ]},
                    // Subject 2: PHY (Physique - 4 units Sec 5)
                    { code: 'PHY-5', name: 'Physique 5e secondaire', competencies: [
                        { name: 'Comp. 1: Problèmes (50%)', assignments: [
                            { category: 'Lab', work: 'Labo Poids', pond: '10', assignedDate: '2025-09-10', dueDate: '2025-09-24', result: '18/20' },
                            { category: 'Exam', work: 'Exam 1', pond: '20', assignedDate: '2025-10-01', dueDate: '2025-10-20', result: '65%' }
                        ]},
                        { name: 'Comp. 2: Théorie (50%)', assignments: [
                            { category: 'Quiz', work: 'Quiz Unités', pond: '5', assignedDate: '2025-09-15', dueDate: '2025-09-15', result: '90%' }
                        ]}
                    ]}
                ],
                etape2: [], // Empty for demonstration
                etape3: [], // Empty for demonstration
            };

            // --- INITIALIZATION ---
            function init() {
                // Load data from localStorage or use dummy data if empty
                mbsData = JSON.parse(localStorage.getItem('mbsData'));
                if (!mbsData || !mbsData.valid || !mbsData.nom) {
                    mbsData = defaultMbsData;
                    // Note: In a real environment, you might not save dummy data immediately, 
                    // but we do so here for the first run demonstration.
                    localStorage.setItem('mbsData', JSON.stringify(mbsData));
                }

                document.getElementById('student-name').textContent = mbsData.nom;
                loadSettings();
                renderAll();
                setupEventListeners();
            }

            // --- DATA & SETTINGS MANAGEMENT ---
            function loadSettings() {
                const settings = mbsData.settings || {};
                document.getElementById('niveau-secondaire').value = settings.niveau || '';
                document.getElementById('unites-mode').value = settings.unitesMode || 'defaut';
                // Update unit button state
                document.getElementById('unites-btn').disabled = settings.unitesMode === 'defaut' || settings.unitesMode === 'sans';
            }

            function saveSettings() {
                mbsData.settings = {
                    niveau: document.getElementById('niveau-secondaire').value,
                    unitesMode: document.getElementById('unites-mode').value,
                    customUnites: mbsData.settings?.customUnites || {}
                };
                localStorage.setItem('mbsData', JSON.stringify(mbsData));
                loadSettings(); // Reload settings to update button state
                renderAll();
            }
            
            function saveCustomUnits() {
                if (document.getElementById('unites-mode').value !== 'perso') return;
                let customUnites = {};
                document.querySelectorAll('.unite-item input').forEach(input => {
                    customUnites[input.dataset.code] = parseFloat(input.value) || 1;
                });
                mbsData.settings.customUnites = customUnites;
                saveSettings();
            }

            function savePonderations() {
                document.querySelectorAll('.pond-input-field.modified-input').forEach(input => {
                    const [etapeKey, subjectIndex, compIndex, assignIndex] = input.dataset.path.split('-');
                    // Ensure the property exists before assignment
                    const subject = mbsData[etapeKey][parseInt(subjectIndex)];
                    const comp = subject.competencies[parseInt(compIndex)];
                    const assign = comp.assignments[parseInt(assignIndex)];

                    if (assign) {
                        assign.pond = input.value;
                    }
                });
                localStorage.setItem('mbsData', JSON.stringify(mbsData));
                renderAll(); // Re-render to remove highlights and update calculations
            }

            // --- RENDERING FUNCTIONS ---
            function renderAll() {
                renderTermTables();
                renderSidePanel();
                document.getElementById('ponderation-controls').classList.add('hidden');
            }

            function renderTermTables() {
                renderTermData(mbsData.etape1, document.getElementById('etape1'));
                renderTermData(mbsData.etape2, document.getElementById('etape2'));
                renderTermData(mbsData.etape3, document.getElementById('etape3'));
            }

            function renderTermData(termData, container) {
                if (!termData || termData.length === 0) {
                    container.innerHTML = `<div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg"><p>Aucune donnée pour cette étape. Vous pouvez <a href="javascript:void(0)" onclick="alert('L'édition des données brutes se ferait sur une page dédiée dans une application complète.')" class="text-indigo-600 hover:text-indigo-800">ajouter vos données</a>.</p></div>`;
                    return;
                }
                container.innerHTML = '';
                termData.forEach((subject, subjectIndex) => {
                    container.appendChild(renderSubjectTable(subject, container.id, subjectIndex));
                });
            }

            function renderSubjectTable(subject, etapeKey, subjectIndex) {
                const table = document.createElement('table');
                table.className = 'subject-table';
                table.innerHTML = `
                    <thead>
                        <tr><th colspan="6">${subject.code} - ${subject.name}</th></tr>
                        <tr><th>Catégorie</th><th>Travail</th><th>Pond.</th><th>Date due</th><th>Résultat</th></tr>
                    </thead>
                    <tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                subject.competencies.forEach((comp, compIndex) => {
                    const compRow = document.createElement('tr');
                    compRow.className = 'competency-row';
                    compRow.innerHTML = `<td colspan="6">${comp.name}</td>`;
                    tbody.appendChild(compRow);

                    comp.assignments.forEach((assign, assignIndex) => {
                        const assignRow = document.createElement('tr');
                        const dataPath = `${etapeKey}-${subjectIndex}-${compIndex}-${assignIndex}`;
                        
                        // Check if the current pond value is different from the saved one
                        const isModified = assign.pond !== document.querySelector(`.pond-input-field[data-path="${dataPath}"]`)?.value;

                        assignRow.innerHTML = `
                            <td>${assign.category || '<span class="no-data">-</span>'}</td>
                            <td>${assign.work || '<span class="no-data">-</span>'}</td>
                            <td><input type="number" class="pond-input-field ${isModified ? 'modified-input' : ''}" value="${assign.pond || ''}" data-path="${dataPath}" placeholder="--"></td>
                            <td>${(assign.dueDate || '').replace('à','')}</td>
                            <td>
                                <div class="grade-container" data-original-result="${assign.result || ''}">
                                    <span class="grade-display">${formatGrade(assign.result)}</span>
                                    <input type="number" class="grade-input-field hidden" min="0" max="100" step="0.1">
                                </div>
                            </td>
                        `;
                        tbody.appendChild(assignRow);
                    });
                });
                return table;
            }

            function renderSidePanel() {
                const averages = calculateAllAverages();
                const formatAvg = (avg) => avg !== null ? `<span class="grade-percentage">${avg.toFixed(2)}%</span>` : '--';

                const globalAvgEl = document.getElementById('moyenne-generale');
                globalAvgEl.innerHTML = formatAvg(averages.globalAverage);
                globalAvgEl.classList.toggle('invalid', averages.globalAverage === null && !!mbsData.etape1);

                const termAvgEl = document.getElementById('moyenne-etape');
                termAvgEl.innerHTML = formatAvg(averages.termAverages[activeTab]);

                const subjectListEl = document.getElementById('subject-averages-list');
                subjectListEl.innerHTML = '';
                const activeTermSubjects = averages.subjectAverages[activeTab];

                if (activeTermSubjects && Object.keys(activeTermSubjects).length > 0) {
                    Object.entries(activeTermSubjects).forEach(([code, subj]) => {
                        const li = document.createElement('li');
                        // Use a consistent name from subjectList if available, or fallback
                        const nameToDisplay = subjectList[code] || subj.name || code;
                        li.innerHTML = `<span>${nameToDisplay}</span><strong>${formatAvg(subj.average)}</strong>`;
                        subjectListEl.appendChild(li);
                    });
                } else {
                    subjectListEl.innerHTML = '<li class="no-data text-center">Aucune matière pour cette étape</li>';
                }
            }

            function populateUnitesModal() {
                const listContainer = document.getElementById('unites-list');
                const mode = document.getElementById('unites-mode').value;
                listContainer.innerHTML = '';

                // Enable/disable save button based on mode
                document.getElementById('save-unites-btn').classList.toggle('hidden', mode !== 'perso');

                const allSubjects = new Map();
                ['etape1', 'etape2', 'etape3'].forEach(etape => {
                    if (mbsData[etape]) {
                        mbsData[etape].forEach(subject => {
                            const codePrefix = subject.code.substring(0, 3);
                            if (!allSubjects.has(codePrefix)) {
                                allSubjects.set(codePrefix, subjectList[codePrefix] || subject.name);
                            }
                        });
                    }
                });

                const units = getUnits();
                // Sort subjects alphabetically for cleaner display
                const sortedSubjects = Array.from(allSubjects.entries()).sort((a, b) => a[1].localeCompare(b[1]));

                sortedSubjects.forEach(([code, name]) => {
                    const item = document.createElement('div');
                    item.className = 'unite-item';
                    let valueDisplay = '';
                    if (mode === 'perso') {
                        const currentValue = (mbsData.settings.customUnites || {})[code] || 2; // Default custom unit to 2 if not set
                        valueDisplay = `<input type="number" data-code="${code}" value="${currentValue}" min="0" step="1">`;
                    } else if (mode === 'sans') {
                        valueDisplay = `<span>1 (Fixe)</span>`;
                    } else { // defaut mode
                        valueDisplay = `<span>${units[code] || 2} (Défaut)</span>`;
                    }
                    item.innerHTML = `<label>${name} (${code})</label>${valueDisplay}`;
                    listContainer.appendChild(item);
                });
            }

            // --- CALCULATION LOGIC (Copied and slightly cleaned from user code) ---

            function getNumericGrade(result) {
                if (!result) return null;
                const trimmed = result.trim();
                if (gradeMap[trimmed]) return gradeMap[trimmed];
                
                const percentageMatch = trimmed.match(/(\d+[,.]?\d*)\s*%/);
                if (percentageMatch) return parseFloat(percentageMatch[1].replace(',', '.'));

                const scoreMatch = trimmed.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);
                if (scoreMatch) {
                    const score = parseFloat(scoreMatch[1].replace(',', '.'));
                    const max = parseFloat(scoreMatch[2].replace(',', '.'));
                    return (max > 0) ? (score / max) * 100 : null;
                }
                return null;
            }
            
            function calculateAllAverages() {
                const units = getUnits();
                const niveau = mbsData.settings?.niveau;
                let allTermAverages = { etape1: null, etape2: null, etape3: null };
                let allSubjectAverages = {};

                ['etape1', 'etape2', 'etape3'].forEach(etape => {
                    if (!mbsData[etape]) return;
                    let termWeightedSum = 0;
                    let termUnitSum = 0;
                    allSubjectAverages[etape] = {};

                    mbsData[etape].forEach((subject, subjectIndex) => {
                        const average = calculateSubjectAverage(subject, etape, subjectIndex);
                        const codePrefix = subject.code.substring(0, 3);
                        allSubjectAverages[etape][codePrefix] = { name: subjectList[codePrefix] || subject.name, average };

                        if (average !== null && niveau) {
                            const unit = units[codePrefix] || 2;
                            termWeightedSum += average * unit;
                            termUnitSum += unit;
                        }
                    });
                    allTermAverages[etape] = termUnitSum > 0 ? termWeightedSum / termUnitSum : null;
                });

                let globalWeightedSum = 0;
                let totalWeight = 0;
                const termWeights = { etape1: 0.20, etape2: 0.20, etape3: 0.60 };
                Object.entries(allTermAverages).forEach(([etape, avg]) => {
                    if (avg !== null) {
                        globalWeightedSum += avg * termWeights[etape];
                        totalWeight += termWeights[etape];
                    }
                });

                const globalAverage = totalWeight > 0 ? globalWeightedSum / totalWeight : null;
                return { subjectAverages: allSubjectAverages, termAverages: allTermAverages, globalAverage };
            }

            function calculateSubjectAverage(subject, etapeKey, subjectIndex) {
                let totalWeightedGrade = 0;
                let totalCompetencyWeight = 0;

                subject.competencies.forEach((comp, compIndex) => {
                    const compWeightMatch = comp.name.match(/\((\d+)%\)/);
                    if (!compWeightMatch) return;
                    const compWeight = parseFloat(compWeightMatch[1]);

                    let totalAssignmentGrade = 0;
                    let totalAssignmentWeight = 0;

                    comp.assignments.forEach((assign, assignIndex) => {
                        const dataPath = `${etapeKey}-${subjectIndex}-${compIndex}-${assignIndex}`;
                        
                        // Try to find the input field for live updates (if present in the DOM)
                        const pondInput = document.querySelector(`.pond-input-field[data-path="${dataPath}"]`);
                        const gradeContainer = pondInput ? pondInput.closest('tr').querySelector('.grade-container') : null;
                        const gradeInput = gradeContainer ? gradeContainer.querySelector('.grade-input-field') : null;

                        let grade = null;
                        if (gradeInput && !gradeInput.classList.contains('hidden') && gradeInput.value.trim() !== '') {
                            // Use live input grade if visible
                            grade = parseFloat(gradeInput.value);
                        } else {
                            // Use original result grade
                            grade = getNumericGrade(assign.result);
                        }

                        let weight = parseFloat(pondInput ? pondInput.value : assign.pond);

                        if (grade !== null && !isNaN(grade) && !isNaN(weight) && weight > 0) {
                            totalAssignmentGrade += grade * weight;
                            totalAssignmentWeight += weight;
                        }
                    });

                    if (totalAssignmentWeight > 0) {
                        const competencyAverage = totalAssignmentGrade / totalAssignmentWeight;
                        totalWeightedGrade += competencyAverage * compWeight;
                        totalCompetencyWeight += compWeight;
                    }
                });

                return totalCompetencyWeight > 0 ? totalWeightedGrade / totalCompetencyWeight : null;
            }

            function getUnits() {
                const { niveau, unitesMode, customUnites } = mbsData.settings || {};
                if (unitesMode === 'sans') return new Proxy({}, { get: () => 1 });
                if (unitesMode === 'perso') return customUnites || {};
                return (niveau && defaultUnits[niveau]) ? defaultUnits[niveau] : {};
            }

            // --- UTILITY & FORMATTING ---
            function formatGrade(result) {
                if (!result) return '<span class="no-data">-</span>';
                const numGrade = getNumericGrade(result);
                const trimmedResult = result.trim();
                
                if (numGrade === null) return trimmedResult;

                const isLetterGrade = !!gradeMap[trimmedResult];
                const scoreMatch = trimmedResult.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);

                if (isLetterGrade) {
                    return `${trimmedResult} <i>(~<span class="grade-percentage">${numGrade.toFixed(1)}%</span>)</i>`;
                }
                if (scoreMatch) {
                    return `<span>${scoreMatch[0]}</span> <span class="grade-percentage">${numGrade.toFixed(1)}%</span>`;
                }
                // Default to raw text if it looks like a percentage (e.g., 85%)
                return `<span class="grade-percentage">${trimmedResult}</span>`;
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                // Tabs
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelector('.tab-btn.active').classList.remove('active');
                        tab.classList.add('active');
                        document.querySelector('.tab-content.active').classList.remove('active');
                        activeTab = tab.dataset.tab;
                        document.getElementById(activeTab).classList.add('active');
                        renderSidePanel();
                    });
                });

                // Settings
                document.getElementById('niveau-secondaire').addEventListener('change', saveSettings);
                document.getElementById('unites-mode').addEventListener('change', () => {
                    saveSettings();
                    // populateUnitesModal() is called inside saveSettings -> renderAll, but we call it here 
                    // to ensure the modal shows the correct state immediately if opened after changing the mode.
                    populateUnitesModal(); 
                });

                // Modals
                const unitesModal = document.getElementById('unites-modal');
                document.getElementById('unites-btn').addEventListener('click', () => {
                    populateUnitesModal();
                    unitesModal.classList.add('active');
                });
                document.getElementById('close-unites-modal').addEventListener('click', () => {
                    saveCustomUnits();
                    unitesModal.classList.remove('active');
                });
                document.getElementById('save-unites-btn').addEventListener('click', () => {
                    saveCustomUnits();
                    unitesModal.classList.remove('active');
                });
                
                // Ponderation controls
                document.getElementById('save-ponds-btn').addEventListener('click', savePonderations);
                document.getElementById('revert-ponds-btn').addEventListener('click', renderAll);

                // Dynamic content listeners (Event Delegation)
                const tabContents = document.getElementById('tab-contents');
                
                tabContents.addEventListener('input', e => {
                    const target = e.target;
                    // Handle Ponderation changes (marks input as modified)
                    if (target.classList.contains('pond-input-field')) {
                        const [etapeKey, subjectIndex, compIndex, assignIndex] = target.dataset.path.split('-');
                        const originalPond = mbsData[etapeKey][subjectIndex].competencies[compIndex].assignments[assignIndex].pond;
                        target.classList.toggle('modified-input', target.value != originalPond);
                        document.getElementById('ponderation-controls').classList.remove('hidden');
                        renderSidePanel();
                    }
                    // Handle Grade input changes (updates real-time average)
                    if (target.classList.contains('grade-input-field')) {
                        renderSidePanel();
                    }
                });

                // Toggle Grade display to input mode
                tabContents.addEventListener('click', e => {
                    const gradeDisplay = e.target.closest('.grade-display');
                    if (gradeDisplay) {
                        const container = gradeDisplay.closest('.grade-container');
                        const inputField = container.querySelector('.grade-input-field');
                        const originalResult = container.dataset.originalResult;
                        const numericGrade = getNumericGrade(originalResult);
                        
                        gradeDisplay.classList.add('hidden');
                        inputField.classList.remove('hidden');
                        inputField.value = numericGrade !== null ? numericGrade.toFixed(2) : '';
                        inputField.focus();
                        inputField.select();
                    }
                });

                // Revert Grade input to display mode (on blur/focusout)
                tabContents.addEventListener('focusout', e => {
                    const target = e.target;
                    if (target.classList.contains('grade-input-field')) {
                         // Check if the input is empty or invalid after focus out
                        if (target.value.trim() === '' || isNaN(parseFloat(target.value))) {
                             // If empty/invalid, hide the input and show the original result
                            target.classList.add('hidden');
                            target.previousElementSibling.classList.remove('hidden');
                        } else {
                            // If a value was entered, keep the input visible for easy editing, but update calculations
                        }
                        renderSidePanel();
                    }
                });

                tabContents.addEventListener('keydown', e => {
                    if (e.target.classList.contains('grade-input-field') && (e.key === 'Enter' || e.key === 'Escape')) {
                        if (e.key === 'Escape') e.target.value = ''; // Clear input on escape
                        e.target.blur(); // Trigger focusout
                    }
                });
                
                // Custom units input changes (inside modal)
                document.getElementById('unites-modal').addEventListener('input', e => {
                    if (e.target.closest('.unite-item') && document.getElementById('unites-mode').value === 'perso') {
                        // Automatically update real-time calculation when custom units are changed
                        // without requiring a full save/close of the modal.
                        saveCustomUnits();
                    }
                });
            }

            // --- START THE APP ---
            init();
        });
        // --- END OF JAVASCRIPT LOGIC ---

        // Note: The user's original code used localStorage for data persistence. 
        // For a collaborative or multi-user application, this should be upgraded to use a persistent database 
        // like Firestore, leveraging the provided __app_id, __firebase_config, and __initial_auth_token.

    </script>
</body>
</html>
