<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mettre à Jour les Données - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb;
            --widget-background: #ffffff; --text-color: #34495e; --light-grey: #bdc3c7;
            --danger-color: #e74c3c; --success-color: #27ae60; --shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
        }
        body { margin: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh; }
        .site-header-container { background-color: var(--widget-background); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-bottom: 1px solid #e0e6eb; padding: 15px 0; position: relative; }
        .site-header { text-align: center; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-weight: 700; font-family: 'Playfair Display', serif; }
        .content { flex-grow: 1; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; }
        .back-arrow { position: absolute; top: 50%; left: 25px; transform: translateY(-50%); font-size: 2.2em; color: var(--secondary-color); text-decoration: none; line-height: 1; transition: color 0.2s, transform 0.2s; font-family: 'Inter', sans-serif; }
        .back-arrow:hover { color: var(--primary-color); transform: translateY(-50%) scale(1.05); }
        .data-widget { background-color: var(--widget-background); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); width: 100%; max-width: 650px; text-align: center; }
        .data-widget h2 { margin-top: 0; font-family: 'Playfair Display', serif; }
        textarea { width: 100%; height: 350px; padding: 15px; border: 2px dashed var(--light-grey); border-radius: 10px; font-family: monospace; font-size: 14px; margin-top: 20px; margin-bottom: 20px; box-sizing: border-box; resize: vertical; transition: all 0.2s; }
        textarea:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        textarea:focus { border-color: var(--primary-color); border-style: solid; box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.2); outline: none; }
        .checkbox-container { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; font-size: 0.9em; line-height: 1.5; }
        .checkbox-container input { margin-right: 10px; transform: scale(1.15); cursor: pointer; }
        .checkbox-container a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .checkbox-container a:hover { text-decoration: underline; }
        #status-message { min-height: 24px; font-weight: 600; margin-top: 15px; transition: color 0.3s; }
        .status-analyzing { color: var(--primary-color); }
        .status-error { color: var(--danger-color); }
        footer { text-align: center; padding: 25px; font-size: 0.9em; color: var(--light-grey); border-top: 1px solid #eee; margin-top: auto; }
        footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="site-header-container">
        <a href="main.html" class="back-arrow" title="Retour au tableau de bord">←</a>
        <header class="site-header">Outil MBS</header>
    </div>

    <main class="content">
        <div class="data-widget">
            <h2>Mettre à Jour les Données</h2>
            <p>Copiez vos notes du portail (Ctrl+A, Ctrl+C) et collez-les ici.</p>
            
            <div class="checkbox-container">
                <input type="checkbox" id="terms-checkbox">
                <label for="terms-checkbox">Je comprends que ces données sont stockées localement sur mon navigateur.</label>
            </div>

            <textarea id="raw-text" placeholder="Veuillez d'abord cocher la case ci-dessus" readonly disabled></textarea>
            
            <div id="status-message"></div>
        </div>
    </main>

    <footer>
        <p>Pour tout problème ou question, vous pouvez <a href="ticket.html">soumettre un ticket</a>.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rawTextArea = document.getElementById('raw-text');
            const termsCheckbox = document.getElementById('terms-checkbox');
            const statusMessage = document.getElementById('status-message');

            // 1. Enable/Disable textarea based on checkbox
            termsCheckbox.addEventListener('change', () => {
                if (termsCheckbox.checked) {
                    rawTextArea.disabled = false;
                    rawTextArea.readOnly = false; // Must be false to allow paste
                    rawTextArea.placeholder = "Collez les données du portail ici... (Ctrl+V)";
                    rawTextArea.focus();
                } else {
                    rawTextArea.disabled = true;
                    rawTextArea.readOnly = true;
                    rawTextArea.placeholder = "Veuillez d'abord cocher la case ci-dessus";
                }
            });

            // 2. Add focus/blur listeners to handle manual typing attempts
            rawTextArea.addEventListener('focus', () => {
                if (!termsCheckbox.checked) return;
                rawTextArea.readOnly = false;
            });

            rawTextArea.addEventListener('blur', () => {
                rawTextArea.readOnly = true;
            });
            
            // 3. Main logic: listen for paste, then analyze and save
            rawTextArea.addEventListener('paste', (event) => {
                if (!termsCheckbox.checked) {
                    event.preventDefault();
                    alert("Veuillez d'abord accepter les conditions en cochant la case.");
                    return;
                }

                // Use a timeout to let the paste operation complete
                setTimeout(() => {
                    const rawText = rawTextArea.value;
                    if (!rawText.trim()) return;

                    statusMessage.textContent = "Analyse en cours...";
                    statusMessage.className = 'status-analyzing';

                    try {
                        const parsedResult = parsePortalData(rawText);

                        if (!parsedResult.nom || !parsedResult.etapeData) {
                            throw new Error("Les données collées sont invalides ou incomplètes. Le nom ou l'étape est introuvable.");
                        }

                        // Overwrite logic as requested
                        const existingData = JSON.parse(localStorage.getItem('mbsData')) || {};
                        const updatedData = {
                            ...existingData,
                            valid: true, // Mark data as valid
                            nom: parsedResult.nom,
                            [parsedResult.etapeKey]: parsedResult.etapeData,
                        };
                        
                        // Add a unique ID if it doesn't exist
                        if (!updatedData.user_random) {
                            updatedData.user_random = 'user-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
                        }
                        
                        localStorage.setItem('mbsData', JSON.stringify(updatedData));
                        
                        // Redirect to the main page after success
                        window.location.href = 'main.html';

                    } catch (error) {
                        statusMessage.textContent = "Erreur : " + error.message;
                        statusMessage.className = 'status-error';
                        rawTextArea.value = ''; // Clear the invalid data
                    }
                }, 10);
            });
        });

        function parsePortalData(text) {
            const nameMatch = text.match(/Photo\s*\n(.+)/);
            const semesterMatch = text.match(/Classe\s*\n\s*(\d)/);
            const nom = nameMatch ? nameMatch[1].trim() : null;
            const etapeNumber = semesterMatch ? semesterMatch[1].trim() : null;
            
            if (!nom || !etapeNumber) return {};
            const etapeKey = `etape${etapeNumber}`;

            const POND_REGEX = /^\d{1,3}$/;
            const DATE_REGEX = /^\d{4}-\d{2}-\d{2}(?: à \d{2}:\d{2})?/;
            const RESULT_REGEX = /^(\d{1,3},\d\s\/\s\d{1,3}\s\(.+\)|[A-DF][+-]?)$/;

            const createNewAssignment = () => ({ textBuffer: [], category: '', work: '', pond: '', assignedDate: '', dueDate: '', result: '' });

            const parseAssignments = (lines) => {
                let assignments = [];
                if (lines.length === 0) return assignments;
                let currentAssignment = createNewAssignment();

                const finalizeAssignment = () => {
                    if (currentAssignment.textBuffer.length === 0 && !currentAssignment.pond && !currentAssignment.result) return;
                    const buffer = currentAssignment.textBuffer;
                    
                    if (buffer.length === 1) {
                        currentAssignment.work = buffer[0];
                    } else if (buffer.length > 1) {
                        currentAssignment.category = buffer[0];
                        currentAssignment.work = buffer.slice(1).join('<br>');
                    }
                    delete currentAssignment.textBuffer; 
                    assignments.push(currentAssignment);
                };

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine || trimmedLine.includes('Catégorie\tTravail\tPond.')) continue;

                    if (RESULT_REGEX.test(trimmedLine)) {
                        currentAssignment.result = trimmedLine;
                        finalizeAssignment();
                        currentAssignment = createNewAssignment();
                    } else if (POND_REGEX.test(trimmedLine)) {
                        currentAssignment.pond = trimmedLine;
                    } else if (DATE_REGEX.test(trimmedLine)) {
                        if (!currentAssignment.assignedDate) {
                            currentAssignment.assignedDate = trimmedLine.split('à')[0].trim();
                        } else {
                            currentAssignment.dueDate = trimmedLine;
                        }
                    } else {
                        if (currentAssignment.pond || currentAssignment.assignedDate) {
                            finalizeAssignment();
                            currentAssignment = createNewAssignment();
                        }
                        currentAssignment.textBuffer.push(trimmedLine);
                    }
                }
                finalizeAssignment();
                return assignments;
            };

            const subjects = [];
            const subjectRegex = /([A-Z]{3}\d{3}[A-Z]?) - (.+)/g;
            const subjectsText = text.split(subjectRegex).slice(1);

            for (let i = 0; i < subjectsText.length; i += 3) {
                const subjectData = { code: subjectsText[i].trim(), name: subjectsText[i + 1].trim(), competencies: [] };
                let subjectContent = subjectsText[i + 2] || '';
                const competencyBlocks = subjectContent.split('Compétence - ').slice(1);

                for (const block of competencyBlocks) {
                    const blockLines = block.trim().split('\n');
                    const compName = blockLines.shift();
                    const cleanLines = blockLines.filter(line => line.trim() && !line.includes('Catégorie\tTravail\tPond.'));
                    const competencyData = {
                        name: `Compétence - ${compName.trim()}`,
                        assignments: parseAssignments(cleanLines)
                    };
                    if (competencyData.assignments.length > 0) {
                        subjectData.competencies.push(competencyData);
                    }
                }
                if (subjectData.competencies.length > 0) {
                    subjects.push(subjectData);
                }
            }
            return { nom, etapeKey, etapeData: subjects };
        }
    </script>
</body>
</html>
